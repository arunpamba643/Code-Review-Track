# Cross-Site Request Forgery (CSRF) — SAST Description
## Description:
Cross-Site Request Forgery (CSRF) is an attack where a malicious website causes a user’s browser to perform unwanted actions on a trusted site where the user is authenticated. If the target application doesn’t verify the origin of the request properly, an attacker can trick users into submitting forged requests — like changing their email, password, or even performing transactions — without their knowledge.

## How SAST Detects CSRF:
SAST tools detect CSRF by analyzing:\
Absence of anti-CSRF tokens in state-changing (non-GET) endpoints.\
Use of unsafe HTTP methods (POST, PUT, DELETE) without CSRF protection.\
Lack of proper SameSite cookie attributes or referrer validation.\
Server-side handlers that process sensitive actions without origin verification.

## Vulnerable code
### CSRF Vulnerable Code (ASP.NET Core MVC)
 If a user is already logged in, an attacker can trick them into making a request without 
their knowledge.\
[HttpPost]\
public IActionResult UpdateEmail(string newEmail)\
{\
 if (User.Identity.IsAuthenticated)\
 {\
 userService.UpdateEmail(User.Identity.Name, newEmail); // No CSRF protection!\
 return Ok("Email updated successfully");\
 }\
 return Unauthorized();\
}
## Secure Code: CSRF Protection with Anti-Forgery Tokens
### Mitigation: Use [ValidateAntiForgeryToken] Attribute
[HttpPost]\
[ValidateAntiForgeryToken] // Protects against CSRF\
public IActionResult UpdateEmail(string newEmail)\
{\
 if (User.Identity.IsAuthenticated)\
 {\
 userService.UpdateEmail(User.Identity.Name, newEmail);\
 return Ok("Email updated securely");\
 }\
 return Unauthorized();\
}\
 Rejects requests without a valid CSRF token.

### CSRF Token Implementation in Views (Razor Pages)
CSRF Token in Forms\
```html
<form method="post" action="/Account/UpdateEmail">
    @Html.AntiForgeryToken() <!-- Generates CSRF token -->
    <input type="email" name="newEmail" required>
    <button type="submit">Update Email</button>
</form>
```
This Razor form includes the anti-forgery token, ensuring that only requests originating from your application's forms are accepted by the server.
 Ensures that only forms generated by your application can make valid requests.

### Global CSRF Protection in ASP.NET Core
 To enable automatic CSRF protection, configure services in Startup.cs.\
public void ConfigureServices(IServiceCollection services)\
{\
 services.AddControllersWithViews(options =>\
 {\
 options.Filters.Add(new AutoValidateAntiforgeryTokenAttribute()); // Enforce CSRF token globally\
 });\
}

### Applies CSRF protection to all POST, PUT, DELETE requests.
CSRF Protection in JavaScript Fetch Requests\
 When using JavaScript to send requests, include the CSRF token in the headers.\
Example Secure AJAX Request
#### javascript
fetch('/Account/UpdateEmail', {\
 method: 'POST',\
 headers: {\
 'Content-Type': 'application/json',\
 'RequestVerificationToken': document.querySelector("input[name='__RequestVerificationToken']").value\
 },\
 body: JSON.stringify({ newEmail: "user@example.com" })\
});\
 Ensures JavaScript requests include a valid CSRF token